# API 接口文档

本文档描述了 `db.py` 和 `llm.py` 中定义的所有 API 接口的使用方法和示例。

## 1. 获取所有房间信息

### 请求方式
GET

### URL
`/api/db/rooms`

### 请求示例
```bash
curl -X GET http://localhost:5000/api/db/rooms
```

### 响应示例
```json
{
  "status": "success",
  "data": [
    {
      "id": "550e8400-e29b-41d4-a716-446655440000",
      "name": "测试房间",
      "worldview": "这是一个测试房间的世界观描述",
      "created_at": "2023-01-01T12:00:00"
    },
    {
      "id": "660e8400-e29b-41d4-a716-446655440000",
      "name": "第二个房间",
      "worldview": "第二个房间的世界观",
      "created_at": "2023-01-02T13:00:00"
    }
  ]
}
```

## 2. 根据房间ID获取角色信息

### 请求方式
GET

### URL
`/api/db/rooms/<room_id>/characters`

### 请求示例
```bash
curl -X GET http://localhost:5000/api/db/rooms/550e8400-e29b-41d4-a716-446655440000/characters
```

### 响应示例
```json
{
  "status": "success",
  "data": [
    {
      "id": "770e8400-e29b-41d4-a716-446655440000",
      "name": "角色A",
      "description": "这是角色A的描述",
      "room_id": "550e8400-e29b-41d4-a716-446655440000",
      "created_at": "2023-01-01T12:30:00"
    },
    {
      "id": "880e8400-e29b-41d4-a716-446655440000",
      "name": "角色B",
      "description": "这是角色B的描述",
      "room_id": "550e8400-e29b-41d4-a716-446655440000",
      "created_at": "2023-01-01T12:35:00"
    }
  ]
}
```

## 3. 根据房间ID获取对话内容

### 请求方式
GET

### URL
`/api/db/rooms/<room_id>/conversations`

### 请求示例
```bash
curl -X GET http://localhost:5000/api/db/rooms/550e8400-e29b-41d4-a716-446655440000/conversations
```

### 响应示例
```json
{
  "status": "success",
  "data": [
    {
      "id": "1110e840-e29b-41d4-a716-446655440000",
      "room_id": "550e8400-e29b-41d4-a716-446655440000",
      "character_id": "770e8400-e29b-41d4-a716-446655440000",
      "character_name": "角色A",
      "content": "你好，很高兴认识你！",
      "created_at": "2023-01-01T13:00:00"
    },
    {
      "id": "2220e840-e29b-41d4-a716-446655440000",
      "room_id": "550e8400-e29b-41d4-a716-446655440000",
      "character_id": "880e8400-e29b-41d4-a716-446655440000",
      "character_name": "角色B",
      "content": "你好，我也很高兴认识你！",
      "created_at": "2023-01-01T13:05:00"
    }
  ]
}
```

## 4. 创建房间

### 请求方式
POST

### URL
`/api/db/rooms`

### 请求示例
```bash
curl -X POST -H "Content-Type: application/json" -d '{"name":"新房间","worldview":"这是一个新创建的房间的世界观"}' http://localhost:5000/api/db/rooms
```

### 响应示例
```json
{
  "status": "success",
  "data": {
    "id": "990e8400-e29b-41d4-a716-446655440000",
    "name": "新房间",
    "worldview": "这是一个新创建的房间的世界观",
    "created_at": "2023-01-03T10:00:00"
  }
}
```

## 5. 创建角色

### 请求方式
POST

### URL
`/api/db/characters`

### 请求示例
```bash
curl -X POST -H "Content-Type: application/json" -d '{"name":"新角色","description":"这是一个新创建的角色的描述","room_id":"990e8400-e29b-41d4-a716-446655440000"}' http://localhost:5000/api/db/characters
```

### 响应示例
```json
{
  "status": "success",
  "data": {
    "id": "aaa0e840-e29b-41d4-a716-446655440000",
    "name": "新角色",
    "description": "这是一个新创建的角色的描述",
    "room_id": "990e8400-e29b-41d4-a716-446655440000",
    "created_at": "2023-01-03T10:05:00"
  }
}
```

## 6. 创建对话记录

### 请求方式
POST

### URL
`/api/db/conversations`

### 请求示例
```bash
curl -X POST -H "Content-Type: application/json" -d '{"room_id":"550e8400-e29b-41d4-a716-446655440000","character_id":"770e8400-e29b-41d4-a716-446655440000","content":"你好，这是一条新的对话记录！"}' http://localhost:5000/api/db/conversations
```

### 响应示例
```json
{
  "status": "success",
  "data": {
    "id": "3330e840-e29b-41d4-a716-446655440000",
    "room_id": "550e8400-e29b-41d4-a716-446655440000",
    "character_id": "770e8400-e29b-41d4-a716-446655440000",
    "character_name": "角色A",
    "content": "你好，这是一条新的对话记录！",
    "created_at": "2023-01-01T14:00:00"
  }
}
```

## 7. 房间控制器API

### 请求方式
POST

### URL
`/api/llm/room_controller`

### 请求示例
```bash
curl -X POST -H "Content-Type: application/json" -d '{
  "world_background": "北宋宣和三年，江南水泊梁山与朝廷对峙之际，苏州城暗流涌动。城中最大的商会「锦记」掌控着江南半数漕运，却暗中资助梁山好汉；而朝廷密探「影卫」已潜入苏州，伺机抓捕通匪之人。江湖侠客、商会子弟、朝廷密探三方势力交织，一场关于忠诚与背叛的较量即将展开。",
  "character_settings": [
    "林冲: 原东京八十万禁军教头，因高俅陷害被逼上梁山，现奉宋江之命潜入苏州，联络「锦记」商会获取粮草支援，性格沉稳隐忍，武艺高强",
    "苏婉清: 「锦记」商会大小姐，聪慧果敢，暗中主持商会资助梁山的事务，对外则以温婉商人形象示人，精通算盘与漕运规则",
    "沈墨: 朝廷「影卫」密探，伪装成苏州府衙的文书，心思缜密，擅长察言观色，任务是查明「锦记」通匪证据并抓捕相关人员",
    "鲁智深: 梁山步军头领，性格豪爽急躁，因担心林冲安危，私自下山赶往苏州，易容成游方僧人，行事冲动但重义气",
    "ai管理员: 剧情引导者，负责把控故事走向（此设定会被接口自动过滤）"
  ],
  "history_messages": [
    "苏婉清: 林教头远道而来，锦记已备妥粮草，只是近日府衙查得甚严，需等三更时分从后门运出",
    "林冲: 多谢苏小姐周全，只是我听闻朝廷密探已潜入苏州，行事需万分谨慎，切勿暴露行踪",
    "沈墨: （在茶馆邻桌假装看文书，实则偷听）这位「林先生」口音不像本地人，且苏大小姐为何深夜与陌生男子密谈？明日需向府尹禀报此事",
    "鲁智深: （拍桌而起）林教头！俺找得你好苦！那朝廷狗官竟敢四处捉拿你，俺这就去砸了府衙，替你出口气！",
    "林冲: （急忙按住鲁智深）师弟不可冲动！此处人多眼杂，你私自下山已违梁山规矩，若暴露身份，不仅粮草无望，你我都将身陷险境！"
  ]
}' http://localhost:5000/api/llm/room_controller
```

### 响应示例
```bash
{
  "model": "glm-4.6",
  "created": 1764925518,
  "choices": [
    {
      "index": 0,
      "finish_reason": "tool_calls",
      "message": {
        "content": "",
        "role": "assistant",
        "reasoning_content": "\n让我分析一下当前的对话情况：\n\n1. 苏婉清告诉林冲粮草已备好，但需要三更时分从后门运出，因为府衙查得严\n2. 林冲提醒苏婉清朝廷密探已潜入苏州，需要谨慎\n3. 沈墨在茶馆偷听，对\"林先生\"的身份产生怀疑，计划向府尹禀报\n4. 鲁智深突然出现，拍桌而起，要替林冲出气砸府衙\n5. 林冲急忙制止鲁智深，提醒他不要冲动，暴露身份会很危险\n\n现在的情况是：\n- 林冲和苏婉清正在进行秘密会面，讨论粮草运输事宜\n- 沈墨已经产生了怀疑，可能会采取行动\n- 鲁智深的出现打破了原有的计划，增加了暴露的风险\n\n这是一个非常紧张的时刻，鲁智深的冲动行为可能会导致整个计划失败。我需要分析当前的人物关系和剧情发展，然后引导剧情走向。\n\n人物关系：\n- 林冲和苏婉清：合作关系，林冲代表梁山，苏婉清代表锦记商会\n- 沈墨：潜在的威胁，正在监视他们\n- 鲁智深：林冲的师弟，但行为冲动，可能成为计划的不确定因素\n\n剧情发展正处于关键时刻，需要引导剧情走向一个合理的方向。我将继续分析鲁智深的行为对局势的影响，并考虑如何化解当前的危机。关键是要平衡各方利益，同时保护林冲和苏婉清的秘密行动。",
        "tool_calls": [
          {
            "id": "call_-8098344590403875327",
            "function": {
              "arguments": "{\"summary\":\"当前剧情正处于关键时刻：林冲与苏婉清在茶馆秘密会面商议粮草运输事宜，朝廷密探沈墨在邻桌偷听并已产生怀疑，而鲁智深突然冲动出现，大声暴露了与林冲的关系，打破了原有的隐蔽计划。人物关系上，林冲与苏婉清是合作关系，沈墨是潜在威胁，鲁智深虽然是林冲师弟但成为计划的最大变数。整个局面因鲁智深的冲动而陷入危机，暴露风险大增。\",\"plot_guidance\":\"剧情应该走向危机处理方向：鲁智深的冲动行为已经引起注意，沈墨的怀疑加深，林冲需要迅速控制局面。建议林冲以巧妙方式化解鲁智深的暴露，比如装作久别重逢的故友，同时苏婉清可以配合转移话题。沈墨可能会进一步试探或暗中跟踪，为后续抓捕行动做准备。这场意外将迫使原计划改变，粮草运输面临更大挑战。\",\"next_speaker\":\"沈墨\"}",
              "name": "analyze_and_guide"
            },
            "type": "function",
            "index": 0
          }
        ]
      }
    }
  ],
  "request_id": "202512051705077a0bbeaae8d04b6c",
  "id": "202512051705077a0bbeaae8d04b6c",
  "usage": {
    "prompt_tokens": 830,
    "prompt_tokens_details": {
      "cached_tokens": 43
    },
    "completion_tokens": 559,
    "total_tokens": 1389
  }
}
```

## 8. 人物控制器API

### 请求方式
POST

### URL
`/api/llm/character_controller`

### 请求示例
```bash
curl -X POST -H "Content-Type: application/json" -d '{
  "world_background": "北宋宣和三年，江南水泊梁山与朝廷对峙之际，苏州城暗流涌动。城中最大的商会「锦记」掌控着江南半数漕运，却暗中资助梁山好汉；而朝廷密探「影卫」已潜入苏州，伺机抓捕通匪之人。江湖侠客、商会子弟、朝廷密探三方势力交织，一场关于忠诚与背叛的较量即将展开。",
  "character_settings": [
    "林冲: 原东京八十万禁军教头，因高俅陷害被逼上梁山，现奉宋江之命潜入苏州，联络「锦记」商会获取粮草支援，性格沉稳隐忍，武艺高强",
    "苏婉清: 「锦记」商会大小姐，聪慧果敢，暗中主持商会资助梁山的事务，对外则以温婉商人形象示人，精通算盘与漕运规则",
    "沈墨: 朝廷「影卫」密探，伪装成苏州府衙的文书，心思缜密，擅长察言观色，任务是查明「锦记」通匪证据并抓捕相关人员",
    "鲁智深: 梁山步军头领，性格豪爽急躁，因担心林冲安危，私自下山赶往苏州，易容成游方僧人，行事冲动但重义气",
    "ai管理员: 剧情引导者，负责把控故事走向（仅作为设定存在，不参与对话）"
  ],
  "history_messages": [
    "苏婉清: 林教头远道而来，锦记已备妥粮草，只是近日府衙查得甚严，需等三更时分从后门运出",
    "林冲: 多谢苏小姐周全，只是我听闻朝廷密探已潜入苏州，行事需万分谨慎，切勿暴露行踪",
    "沈墨: （在茶馆邻桌假装看文书，实则偷听）这位「林先生」口音不像本地人，且苏大小姐为何深夜与陌生男子密谈？明日需向府尹禀报此事",
    "鲁智深: （拍桌而起）林教头！俺找得你好苦！那朝廷狗官竟敢四处捉拿你，俺这就去砸了府衙，替你出口气！",
    "林冲: （急忙按住鲁智深）师弟不可冲动！此处人多眼杂，你私自下山已违梁山规矩，若暴露身份，不仅粮草无望，你我都将身陷险境！"
  ],
  "admin_analysis": {
    "summary": "剧情进展：林冲与苏婉清商议粮草运输事宜时，被朝廷密探沈墨暗中监视；鲁智深私自下山闯入茶馆，冲动行为暴露了两人行踪风险，目前茶馆内已有其他食客察觉异常，沈墨已对「林先生」产生怀疑。人物关系：林冲与鲁智深为梁山同门（师兄弟），苏婉清是梁山的资助者（与林冲为合作关系），沈墨是对立势力（朝廷密探，目标是抓捕通匪者）。",
    "plot_guidance": "当前核心冲突是「行踪暴露风险」，需优先解决鲁智深冲动引发的危机：苏婉清作为商会主事人，需快速控制局面（安抚鲁智深、掩盖异常），同时应对沈墨可能的进一步试探；需推动沈墨采取行动（如上前盘问），加剧三方势力的直接碰撞，避免剧情停滞。",
    "next_speaker": "苏婉清"
  },
  "character_name": "苏婉清"
}' http://localhost:5000/api/llm/character_controller
```

### 响应示例
```bash
{
  "model": "glm-4.6",
  "created": 1764926102,
  "choices": [
    {
      "index": 0,
      "finish_reason": "tool_calls",
      "message": {
        "content": "",
        "role": "assistant",
        "reasoning_content": "\n当前情况分析：\n1. 鲁智深冲动拍桌而起，暴露了与林冲的关系，引起了茶馆内其他食客的注意\n2. 沈墨正在暗中监视，已经对\"林先生\"产生怀疑\n3. 苏婉清作为商会主事人，需要快速控制局面，避免暴露\n4. 核心冲突是行踪暴露风险，需要苏婉清来化解危机\n\n苏婉清的性格特点：\n- 聪慧果敢\n- 对外以温婉商人形象示人\n- 精通算盘与漕运规则\n- 暗中主持商会资助梁山的事务\n\n在这种情况下，苏婉清应该：\n1. 快速安抚鲁智深，避免他继续冲动\n2. 用商人身份来解释鲁智深的出现，掩盖异常\n3. 维持表面的平静，不引起更多怀疑\n4. 可能需要对沈墨有所回应或解释\n\n我需要让苏婉清以温婉但果断的方式处理这个危机。",
        "tool_calls": [
          {
            "id": "call_-8098344418604816359",
            "function": {
              "arguments": "{\"response_content\":\"（起身轻按鲁智深肩膀，温婉笑道）这位大师息怒，家父与林先生乃是故交，今日相会不过是为漕运生意。大师若是不嫌，请到后院用些斋饭，再细说家事不迟。（转向林冲，眼中带着歉意）林先生见谅，家师心直口快，莫要见怪。（瞥向沈墨方向，若无其事地整理茶具）这茶楼人多嘈杂，不如移步后院清静。\",\"next_speaker\":\"沈墨\"}",
              "name": "character_response_with_next"
            },
            "type": "function",
            "index": 0
          }
        ]
      }
    }
  ],
  "request_id": "20251205171456a4c1cd88ed0f475d",
  "id": "20251205171456a4c1cd88ed0f475d",
  "usage": {
    "prompt_tokens": 1013,
    "prompt_tokens_details": {
      "cached_tokens": 43
    },
    "completion_tokens": 360,
    "total_tokens": 1373
  }
}
```